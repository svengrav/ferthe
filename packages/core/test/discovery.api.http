### Discovery API Tests
### This file contains comprehensive tests for the Discovery API
###
### SETUP - Generate Fresh Dev Token:
### Run: deno run -A packages/core/test/generate-token.ts
### Copy the generated token and update @devToken below
###
### Token Info:
### - Valid for 30 days from generation
### - Uses test account: xxxxdevtestuserxxxxx
### - Matches sandbox data in packages/test/src/sandbox/data.ts
###
### All requests use @devToken for authentication

@baseUrl = http://localhost:3000
@devToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhY2NvdW50SWQiOiJ4eHh4ZGV2dGVzdHVzZXJ4eHh4eCIsImFjY291bnRUeXBlIjoic21zX3ZlcmlmaWVkIiwiaWF0IjoxNzcwOTg1ODM5LCJleHAiOjE3NzM1Nzc4MzksImlzcyI6ImZlcnRoZS1hcGkiLCJhdWQiOiJmZXJ0aGUtYXBwIn0.KgAT--0wXyveEbrtfrwICyEG3lVGLUR7B_J7D9OPs5c
@devUserId = xxxxdevtestuserxxxxx
@testTrailId = cmc35a2qc12ome60777f19f2b
@testSpotId = clx4j9k2n000301mh9e5p6t4w


### =================================================================
### DISCOVERY PROFILE & STATS
### =================================================================

###
# 1. Get Discovery Profile
GET {{baseUrl}}/core/api/v1/discovery/profile
Authorization: Bearer {{devToken}}

###
# 2. Get Trail Stats
GET {{baseUrl}}/core/api/v1/trails/{{testTrailId}}/stats
Authorization: Bearer {{devToken}}


### =================================================================
### LOCATION PROCESSING & DISCOVERY
### =================================================================

###
# 3. Process Location - Discover spots by location
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json
Authorization: Bearer {{devToken}}

{
  "location": {
    "lat": 51.797,
    "lon": 7.627
  },
  "trailId": "{{testTrailId}}"
}

###
# 4. Get All Discoveries for User
GET {{baseUrl}}/core/api/v1/discovery/collections/discoveries
Authorization: Bearer {{devToken}}

###
# 5. Get Discoveries for Specific Trail
GET {{baseUrl}}/core/api/v1/discovery/collections/discoveries?trailId={{testTrailId}}
Authorization: Bearer {{devToken}}

###
# 6. Get Discovered Spots (All)
GET {{baseUrl}}/core/api/v1/discovery/collections/spots
Authorization: Bearer {{devToken}}

###
# 7. Get Discovered Spots for Specific Trail
GET {{baseUrl}}/core/api/v1/discovery/collections/spots?trailId={{testTrailId}}
Authorization: Bearer {{devToken}}

###
# 8. Get Preview Clues for Trail
GET {{baseUrl}}/core/api/v1/discovery/collections/trails/{{testTrailId}}/clues
Authorization: Bearer {{devToken}}

###
# 9. Get Discovery Trail Data
GET {{baseUrl}}/core/api/v1/discovery/collections/trails/{{testTrailId}}
Authorization: Bearer {{devToken}}

###
# 10. Process Multiple Locations - Simulate Movement
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json
Authorization: Bearer {{devToken}}

{
  "location": {
    "lat": 51.794,
    "lon": 7.619
  },
  "trailId": "{{testTrailId}}"
}

###
# 11. Test Discovery on Nature Trail
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json
Authorization: Bearer {{devToken}}

{
  "location": {
    "lat": 51.778,
    "lon": 7.625
  },
  "trailId": "clx4j9k2n000201mh7b3m5r8x"
}

###
# 12. Get Discoveries for Nature Trail
GET {{baseUrl}}/core/api/v1/discovery/collections/discoveries?trailId=clx4j9k2n000201mh7b3m5r8x
Authorization: Bearer {{devToken}}

### =================================================================
### ERROR TESTING
### =================================================================

###
# 13. Test Invalid Location (should not discover anything)
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json
Authorization: Bearer {{devToken}}

{
  "location": {
    "lat": 0.0,
    "lon": 0.0
  },
  "trailId": "{{testTrailId}}"
}

###
# 14. Test Invalid Trail ID
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json
Authorization: Bearer {{devToken}}

{
  "location": {
    "lat": 51.797,
    "lon": 7.627
  },
  "trailId": "invalid-trail-id"
}

###
# 15. Test Without Authentication (should fail)
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json

{
  "location": {
    "lat": 51.797,
    "lon": 7.627
  },
  "trailId": "{{testTrailId}}"
}

###
# 16. Test Invalid Bearer Token
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json
Authorization: Bearer invalid-token-here

{
  "location": {
    "lat": 51.797,
    "lon": 7.627
  },
  "trailId": "{{testTrailId}}"
}

### =================================================================
### VALIDATION REQUESTS
### =================================================================

###
# 17. Validate Session
POST {{baseUrl}}/core/api/v1/account/session/validate
Content-Type: application/json

{
  "sessionToken": "{{devToken}}"
}

###
# 18. Get Account Details
GET {{baseUrl}}/core/api/v1/account/collections/accounts
Authorization: Bearer {{devToken}}

###
# 19. Get All Trails (for reference)
GET {{baseUrl}}/core/api/v1/trail/collections/trails
Authorization: Bearer {{devToken}}

###
# 20. Get Specific Trail Data
GET {{baseUrl}}/core/api/v1/trail/collections/trails/{{testTrailId}}
Authorization: Bearer {{devToken}}

###
# 21. Get All Spots (for reference)
GET {{baseUrl}}/core/api/v1/trail/collections/spots
Authorization: Bearer {{devToken}}

### =================================================================
### ADVANCED DISCOVERY SCENARIOS
### =================================================================

###
# 22. Rapid Location Updates (simulate real movement)
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json
Authorization: Bearer {{devToken}}

{
  "location": {
    "lat": 51.799,
    "lon": 7.63
  },
  "trailId": "{{testTrailId}}"
}

###
# 23. Test Boundary Location (edge of discovery radius)
POST {{baseUrl}}/core/api/v1/discoveries/process
Content-Type: application/json
Authorization: Bearer {{devToken}}

{
  "location": {
    "lat": 51.7972,
    "lon": 7.6272
  },
  "trailId": "{{testTrailId}}"
}

###
# 24. Final Discovery Status Check
GET {{baseUrl}}/core/api/v1/discovery/collections/discoveries
Authorization: Bearer {{devToken}}

###
# 25. Final Discovered Spots Check
GET {{baseUrl}}/core/api/v1/discovery/collections/spots
Authorization: Bearer {{devToken}}